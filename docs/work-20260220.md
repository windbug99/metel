# Hybrid LLM Agent 개선 작업계획

## 목표
- LLM은 해석/계획/요약에 집중하고, 실행/검증/보안은 규칙 엔진이 담당하는 하이브리드 구조로 전환
- 서비스 오선택(예: Linear 요청 중 Notion 도구 오남용)과 반복 실패(turn 낭비) 최소화
- 실환경 성공률/재현성/디버깅 용이성 개선

## 설계 원칙
- `LLM`: 의도 추출, 태스크 분해, 도구 후보 제안, 텍스트 요약/변환
- `Rule`: 서비스-도구 정합성 검증, 권한/스키마 검증, 결정적 실행, 완료 판정
- 실행기는 **확정된 Plan만** 수행하고, 실행 중 임의 도구 확장은 금지

## 단계별 LLM 사용 정의 및 적용 현황
- [x] 입력 정규화/보안 필터: `Rule` 중심 적용
  - 적용: data source ID 형식 검증, tool payload 스키마 검증
  - 미완: 프롬프트 인젝션/민감정보 마스킹 전용 레이어
- [x] 의도/요구사항 추출: `LLM` 적용
  - 적용: LLM planner + rule fallback
- [x] 서비스/도구 초안 선택: `LLM` 적용 + `Rule` 보정
  - 적용: LLM 후보 제안 후 cross-service 누수/필수도구 정합성 재검증
- [x] 정합성/권한 검증: `Rule` 적용
  - 적용: service-tool 정합성, 필수 도구 조건, payload 타입 검증
- [x] 실행 계획 확정(DAG): `Rule` 중심 + `LLM` 보조
  - 적용: `tasks(TOOL/LLM, depends_on)` 기반 오케스트레이션
- [x] 도구 실행: `Rule`(결정적 실행기) 적용
  - 적용: executor/tool_runner에서 결정적 호출
- [x] API 없는 중간 작업(요약/변환): `LLM` 적용
  - 적용: task_type=`LLM` 요약 + 문장수 후검증
- [x] 완료 검증: `Rule` 우선, 필요 시 `LLM` 보조
  - 현황: Rule verifier + 옵션형 LLM verifier 보조 적용
- [x] 최종 응답 생성: `LLM 또는 템플릿`
  - 현황: 옵션형 템플릿 finalizer 적용(`LLM_RESPONSE_FINALIZER_ENABLED`), 실행 근거(step) 포함 응답 포맷 반영
- [x] 관측/학습 루프: `Rule` 기반
  - 현황: 품질 게이트 평가 + 정책 추천 자동 반영 루프(`scripts/run_hybrid_learning_loop.sh`) 적용

## 단계별 작업

- [x] 1. Plan 계약(Contract) 고정
  - `Task(type=TOOL|LLM, service, tool_name, input, depends_on, output_schema)` 필수 필드 강제
  - LLM planner 출력 JSON 스키마 엄격화
  - 진행상태: `완료` (task contract 검증 게이트 추가, output_schema 필수화, 계약 위반 LLM task는 synthesized task로 차단/대체)
  - 완료기준: 스키마 위반 plan 100% 차단

- [x] 2. 서비스-의도 정합성 게이트 강화
  - 요청 의도와 서비스/도구의 허용 매트릭스 정의(예: linear 요청에서 notion retrieve 차단)
  - `append/rename/archive/query_data_source` 등 필수 도구 조건 강화
  - 진행상태: `완료` (cross-service 누수 감지 및 rule fallback 재정렬 반영)
  - 완료기준: 부정합 plan 자동 보정 또는 즉시 실패 반환

- [x] 3. 도구 선택 정책 변경(autonomous fan-out 축소)
  - `allowed_tools = plan.selected_tools (+ 엄격한 필수 보조 도구만)`
  - 실행 중 `updated_selected_tools`로 임의 확장 금지
  - 진행상태: `완료` (strict scope 로직 + config/env 연결 + `updated_selected_tools` 임의 확장 차단 반영)
  - 완료기준: cross-service 불필요 호출 재현 케이스 제거

- [x] 4. 결정적 실행기 우선화
  - TOOL task는 deterministic executor가 순차 실행
  - LLM task만 모델 호출 허용
  - 진행상태: `완료` (task orchestration 경로에서 TOOL/LLM 분리 실행)
  - 완료기준: 동일 입력에 동일 실행 경로 재현 가능

- [x] 5. LLM 출력 후검증 강화
  - 요약/변환 출력의 문장수/길이/형식/금칙어 검증
  - 실패 시 1회 재생성 후 fallback 규칙 적용
  - 진행상태: `완료` (문장수/길이/형식/금칙어 검증 + 1회 재생성 + 라인수/번호 형식 강제 반영)
  - 완료기준: 형식 오류로 인한 후속 TOOL 실패 감소

- [x] 6. 완료 판정(Verifier) 이중화
  - Rule verifier를 1차 기준으로 사용(필수 도구 호출/아티팩트 확인)
  - 필요 시 LLM verifier 보조 사용
  - 진행상태: `완료` (Rule verifier + 옵션형 LLM verifier + fail-open/fail-closed/검증 이력/증거요구 튜닝 옵션 반영)
  - 완료기준: “완료” 오판정률 감소

- [x] 7. 실환경 장애 케이스 회귀 테스트 추가
  - 재현 케이스: “linear 요청인데 notion으로 샘”, “invalid start_cursor 반복”, “data_source 정렬 필드 불일치”
  - 단위/통합/라이브 스모크 케이스로 분리
  - 진행상태: `완료` (cross-service 누수/invalid start_cursor/data_source sort 불일치 회귀 테스트 반영 + mock/e2e 테스트 통과 + 라이브 스모크 2종 연속 성공. data_source_id 미지정 시 fallback 시나리오로 자동 실행하도록 보강)
  - 완료기준: 재현 케이스 테스트 고정 및 통과

- [x] 8. 운영 지표/가드레일 도입
  - 지표: cross-service 호출률, turn당 실패율, replan 비율, verification 실패 사유
  - 임계치 초과 시 자동 강등(policy): autonomous->deterministic
  - 진행상태: `완료` (autonomous 실행 지표 수집/기록 + 임계치 강등 + 품질 게이트 스크립트 하이브리드 지표 반영 완료)
  - 완료기준: 품질 게이트 스크립트에 하이브리드 지표 반영

- [x] 9. 릴리즈/롤백 계획 수립
  - feature flag로 단계적 배포(`STRICT_TOOL_SCOPE`, `HYBRID_EXECUTOR_FIRST`)
  - 롤백 절차 문서화
  - 진행상태: `완료` (`LLM_HYBRID_EXECUTOR_FIRST`, `LLM_AUTONOMOUS_STRICT_TOOL_SCOPE` 플래그 반영 및 즉시 롤백 가능한 스위치 확보)
  - 완료기준: 장애 시 5분 내 이전 정책 복귀 가능

## 릴리즈/롤백 체크포인트
- 단계적 릴리즈 순서
  - 1) `LLM_AUTONOMOUS_STRICT_TOOL_SCOPE=true` 적용
  - 2) `LLM_AUTONOMOUS_GUARDRAIL_ENABLED=true` + 임계치 기본값 적용
  - 3) 필요 시 `LLM_AUTONOMOUS_VERIFIER_ENABLED=true` 적용
  - 4) 안정성 우선 구간은 `LLM_HYBRID_EXECUTOR_FIRST=true`로 deterministic 우선 실행
- 즉시 롤백(5분 내)
  - 1) `LLM_HYBRID_EXECUTOR_FIRST=true` 설정 (autonomous 우회)
  - 2) `LLM_AUTONOMOUS_VERIFIER_ENABLED=false` 설정
  - 3) 필요 시 `LLM_AUTONOMOUS_ENABLED=false` 설정
  - 4) 서비스 재시작 후 헬스체크(`/api/health`) 및 스모크 요청 1건 확인

## 우선순위(실행 순서)
1. 2단계 정합성 게이트 강화
2. 3단계 도구 선택 정책 변경
3. 4단계 결정적 실행기 우선화
4. 7단계 회귀 테스트 추가
5. 8단계 운영 지표 반영

## 완료 판정(DoD)
- 재현 케이스에서 cross-service 오동작 0건
- 백엔드 테스트 전량 통과
- 라이브 E2E 시나리오 2종(Linear->요약->Notion, DataSource->요약->Notion) 연속 성공
- 실패 로그에서 원인 분류가 명확히 식별 가능

## 실행 명령(검증)
```bash
cd backend
source .venv/bin/activate
python -m pytest -q tests
python scripts/run_agent_live_e2e.py --user-id <USER_ID> --data-source-id <DATA_SOURCE_ID>
./scripts/run_hybrid_learning_loop.sh
# 실제 반영: APPLY_POLICY=true ./scripts/run_hybrid_learning_loop.sh
```
