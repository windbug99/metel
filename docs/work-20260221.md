# 2026-02-21 작업 계획 (2단계 순차 진행)

## 목표
- 자연어 요청 성공률 향상
- 필수 입력 누락 실패 최소화
- `LLM(해석/추출) + Rule(검증/실행)` 하이브리드 안정화

## 작업 1: 슬롯 보완 기반 실행 안정화
### 1-1. 슬롯 스키마 표준화
- 액션별 `required_slots`, `optional_slots`, `aliases`, `validation_rules` 정의

### 1-2. 슬롯 추출/보완
- 규칙 기반 1차 추출 + LLM 보조 추출
- 컨텍스트(최근 팀/이슈/페이지) + 검색툴(`notion_search`, `linear_search_issues`, `linear_list_teams`) 자동 보완

### 1-3. 대화형 보완 루프
- 누락 슬롯이 있으면 실행 대신 질문
- 한 번에 1개 슬롯만 질문, 답변 병합 후 재검증/재실행

### 1-4. Pending Action 상태관리
- `intent`, `collected_slots`, `missing_slots`, `expires_at`, `user_id` 저장
- TTL/취소/새 요청 대체 정책 적용

### 1-5. 실행 가드/에러 가이드
- 실행 직전 최종 검증
- 실패 시 `누락 항목 + 입력 예시`를 표준 응답으로 반환

### 1-6. 테스트
- 단위: 슬롯 추출/검증/보완
- 통합: `3/4 충족 -> 질문 -> 2턴 성공`

## 작업 2: LLM 구조화 파서 전환(정규식 의존 축소)
### 2-1. LLM 구조화 추출기 도입
- 사용자 문장을 `intent + slots(JSON)`로 변환
- 스키마 강제(타입/필수필드/enum)

### 2-2. 정규식 역할 축소
- 기존 정규식 파서는 fallback/보조로만 사용

### 2-3. 실행 파이프라인 이관
- 실행기는 검증 완료된 슬롯만 받아 API 호출
- 의미 해석은 LLM, 실행 결정은 Rule로 분리

### 2-4. 문장 다양성 회귀 테스트
- 표현 순서 변경, 후행 본문, 존댓말/축약형, 혼합 지시문 케이스 추가

## 작업 3: 공통 순차 질문 루프 고도화 (추가 개선안)
### 3-1. 슬롯 계약 정리 (Schema v2)
- 액션별 `required / optional / auto_fill / ask_order / aliases / validators` 확장
- Linear/Notion 주요 mutation부터 우선 적용

### 3-2. 슬롯 수집기 분리 (`slot_collector`)
- 입력: 사용자 문장, pending 상태, 실행 컨텍스트
- 처리: LLM 추출 + alias 정규화 + confidence + 규칙 검증
- 출력: `collected_slots`, `missing_slots`, `ask_next_slot`

### 3-3. Pending Action 영속화 (DB)
- 저장: `user_id`, `intent`, `action`, `task_id`, `collected_slots`, `missing_slots`, `expires_at`, `status`
- 정책: `cancel`, `replace_on_new_request`, `ttl_expire`

### 3-4. 질문 루프 공통화
- 한 번에 1개 슬롯만 질문
- 질문 템플릿 표준화(필요 이유 + 예시 1개 + 취소 안내)

### 3-5. 실행 파이프라인 단일화
- 실행기는 `validated task.payload`만 사용
- 분기별 정규식 추출 제거, fallback만 유지

### 3-6. 자동 보완 강화
- `linear_list_teams`, `linear_search_issues`, `notion_search` 보완 흐름 고도화
- low-confidence 슬롯 재확인 질문

### 3-7. 실패/가이드 표준화
- `validation_error` 응답을 `missing_slot + example + next_action` 형태로 통일

### 3-8. 테스트 체계 확장
- 단위: collector/validator/pending 정책
- 통합: 2~3턴 완료, 취소/만료/새요청 대체

### 3-9. 단계적 릴리스
- feature flag 점진 적용
- 메트릭: 질문 루프 완료율/validation_error 비율/평균 턴 수
- 플래그: `slot_loop_enabled`, `slot_loop_rollout_percent`, `slot_loop_metrics_enabled`

## 순차 진행 체크리스트
- [x] 작업 1-1 슬롯 스키마
- [x] 작업 1-2 슬롯 추출/자동보완
- [x] 작업 1-3 질문 루프
- [x] 작업 1-4 Pending Action
- [x] 작업 1-5 실행 가드/에러 가이드
- [x] 작업 1-6 테스트
- [x] 작업 2-1 LLM 구조화 추출기
- [x] 작업 2-2 정규식 축소
- [x] 작업 2-3 실행 파이프라인 이관
- [x] 작업 2-4 회귀 테스트
- [x] 작업 3-1 슬롯 계약 정리 (Schema v2)
- [x] 작업 3-2 슬롯 수집기 분리
- [x] 작업 3-3 Pending Action 영속화 (DB)
- [x] 작업 3-4 질문 루프 공통화
- [x] 작업 3-5 실행 파이프라인 단일화
- [x] 작업 3-6 자동 보완 강화
- [x] 작업 3-7 실패/가이드 표준화
- [x] 작업 3-8 테스트 체계 확장
- [x] 작업 3-9 단계적 릴리스

## 완료 기준(DoD)
- 누락 파라미터 요청이 2턴 내 정상 수행
- `validation_error` 비율 감소
- Notion/Linear 기존 주요 시나리오 회귀 없음

## 기대효과
- 다양한 문장 구조 입력 처리율 향상
- 실패 메시지 대신 상호작용형 보완으로 사용자 경험 개선
- 서비스 추가 시 슬롯/스키마 중심 확장 가능
- 장애 원인 추적 및 디버깅 속도 개선
