# 2026-02-22 작업 계획 (대화형 UX 전환)

## 목표
- 텔레그램 응답을 사용자 대화 중심 UX로 전환
- 디버깅용 상세 리포트는 테스트 모드에서만 노출
- 운영 사용자 관점에서 과도한 내부 로그 노출 제거

## 우선 적용 범위(주요 작업)
- 포함:
  - UX 제안 1. 필수 슬롯 1개씩 질문
  - UX 제안 2. 자동 보완 우선 + 불확실 시 확인 질문
  - UX 제안 3. 사용자 인지 부하 최소화(1~3문장, 비기술 용어)
  - UX 제안 4. 상태 기반 응답 템플릿 고정(성공/추가입력 필요/실패)
  - UX 제안 7. 실패 복구 루프 표준화(`validation_error` 재질문 + 예시)
- 제외(추가 작업으로 분리):
  - UX 제안 5. 위험 작업 실행 전 명시적 확인 게이트
  - UX 제안 8. 선택형 옵션(버튼/번호 선택) 기반 입력 UX

## 작업 1: 완전 대화형 모드 도입
### 1-1. 모드 플래그 설계
- `conversation_mode_enabled` 플래그 추가
- 기본값: `true`(운영), 필요 시 환경변수로 비활성화 가능

### 1-2. 응답 생성 파이프라인 분리
- `user_facing_message`(대화형 본문) 생성
- `debug_report_message`(기존 "에이전트 실행 결과" 블록) 분리 생성

### 1-3. 대화형 응답 규칙 고정
- 1~3문장 내 핵심 요약
- 실행 성공/실패/추가입력 필요 상태별 템플릿 + 조건부 LLM 리라이트
- 사실 추가 금지, ID/링크/수치 변조 금지

### 1-4. 슬롯 질문 UX 통일
- 누락 슬롯 질문은 대화형 문체 우선
- 한 번에 1개 슬롯만 질문(필수 파라미터 우선)
- 이유 + 예시 + 취소 안내를 유지
- 불필요한 기술 용어 최소화

### 1-5. 실패 복구 대화 흐름
- `validation_error` 시 다음 입력 유도 문장 강화
- 오류 사유 + 올바른 입력 예시를 함께 제시
- orphan slot 입력 시 "작업 재시작 안내" 대화형 문장 유지

## 작업 2: "에이전트 실행 결과" 블록 테스트 모드 한정
### 2-1. 디버그 출력 플래그 추가
- `telegram_debug_report_enabled` 플래그 추가
- 기본값: `false`(운영), 테스트 환경에서만 `true`

### 2-2. 텔레그램 전송 정책 적용
- `telegram_debug_report_enabled=true`:
  - `대화형 답변 + 에이전트 실행 결과 블록` 동시 출력
- `telegram_debug_report_enabled=false`:
  - `대화형 답변`만 출력

### 2-3. 로깅/추적 유지
- 사용자 메시지에 디버그 블록을 숨겨도
- `command_logs`에는 plan/execution 메타데이터 계속 기록

### 2-4. 운영 안전장치
- 메시지 길이 제한 초과 시 자동 축약
- 디버그 블록 off 상태에서 내부 정보 노출 회귀 테스트

## 작업 3: LLM 주도 해석 + 실행 단일화 (구조 개선)
### 3-1. 문제 재정의 및 경계 통일
- 원인 명시:
  - LLM 해석 계층과 실행 계층(정규식/개별 분기) 분리로 불일치 발생
  - 라우팅 키워드 오인(예: `상태`)
  - 슬롯 루프/오토필/ID 해석 로직 파편화
- 목표 경계:
  - `해석(LLM)` / `검증·실행(Rule)` 책임 분리

### 3-2. LLM 단일 구조화 출력 고정
- 요청문 + 연결 서비스 + 도구 목록 입력
- 출력 스키마:
  - `service`, `tool`, `slots`, `workflow`, `confidence`
- 스키마 위반 시 재시도/보정 규칙 정의

### 3-3. Rule 최소 검증 계층
- 검증 범위:
  - 연결 상태, 권한(scope), 필수 슬롯, 타입, 안전 정책
- 해석 재수행 금지:
  - Rule 계층에서 의미 재해석/정규식 파편 추출 금지
- 진행 메모(2026-02-21):
  - `planner=llm` 계획에서는 Rule 계층의 사용자문장 재해석(정규식 오토필)을 기본 차단
  - 예외적으로 필요한 경우에만 `RULE_REPARSE_FOR_LLM_PLAN_ENABLED=true`로 임시 허용

### 3-4. 슬롯 보완 공통 루프 완전 일원화
- 자동보완:
  - 팀키 -> `team_id`
  - 이슈키 -> 내부 `issue_id`
  - 페이지명 -> `page_id`
- 자동보완 우선 적용 후 부족 시 1슬롯 질문
- 불확실 값은 확인 질문으로 확정
- 임의 생성 금지(특히 변경/삭제 계열)

### 3-5. 실행기 단일화
- 실행 입력은 `validated payload`만 사용
- 액션별 분기 정규식 제거(진짜 fallback만 유지)
- 오토필 후 재검증 -> 실패 시 다시 슬롯 루프 복귀

### 3-6. 결과 출력/관측 일원화
- 사용자 출력:
  - 대화형 요약(LLM)
  - 테스트 모드에서만 상세 실행 리포트
- 내부 관측:
  - 요청문/추출 slots/최종 payload/실패코드 로깅
  - 실패 케이스 자동 테스트 편입 파이프라인 추가

## 순차 진행 체크리스트
- [x] 작업 1-1 모드 플래그 설계
- [x] 작업 1-2 응답 생성 파이프라인 분리
- [x] 작업 1-3 대화형 응답 규칙 고정
- [x] 작업 1-4 슬롯 질문 UX 통일
- [x] 작업 1-5 실패 복구 대화 흐름
- [x] 작업 2-1 디버그 출력 플래그 추가
- [x] 작업 2-2 텔레그램 전송 정책 적용
- [x] 작업 2-3 로깅/추적 유지
- [x] 작업 2-4 운영 안전장치
- [x] 작업 3-1 문제 재정의 및 경계 통일
- [x] 작업 3-2 LLM 단일 구조화 출력 고정
- [x] 작업 3-3 Rule 최소 검증 계층
- [x] 작업 3-4 슬롯 보완 공통 루프 완전 일원화
- [x] 작업 3-5 실행기 단일화
- [x] 작업 3-6 결과 출력/관측 일원화

## 완료 기준(DoD)
- 운영 모드에서 사용자에게는 대화형 답변만 노출
- 테스트 모드에서 기존 "에이전트 실행 결과" 블록을 함께 확인 가능
- 슬롯 질문/실패 복구 시나리오 회귀 없음
- 텔레그램 주요 E2E 케이스 테스트 통과
- LLM 구조화 출력 -> 검증 -> 실행 파이프라인이 단일 경로로 수렴
- 동일 요청 재현 시 파라미터 전달 불일치(해석/실행 불일치) 재발 없음

## 진행 메모 (2026-02-22 추가)
- 레거시 우회 경로 제거:
  - `planner.build_execution_tasks`의 "selected_tools -> 무조건 TOOL task 변환" fallback 제거
  - `executor.execute_agent_plan`의 서비스별 레거시 실행 분기(`_execute_linear_plan`, `_execute_notion_plan` 등) 진입 제거
  - 실행은 `task orchestration` 단일 경로로 고정, 실패 시 `task_orchestration_unavailable`로 fail-closed
- 텔레그램 응답 경로 단순화:
  - 레거시 rollback 응답 모드 제거
  - preface LLM 재작성 분기 제거(결정론적 사용자 메시지 고정)
  - debug 플래그가 켜진 경우에만 상세 리포트 병합
- 슬롯 루프 안정화 보완:
  - 보류 작업 재개 후 실행 단계에서 다시 `validation_error`가 발생할 때 pending 상태를 재저장하도록 공통 루프 보강

## 구조 단순화 리팩토링 계획 (LLM + 공통 로직 중심)
### 목표 구조
- 입력 수신
- LLM 구조화 해석: `target_services`, `selected_tools`, `slots_by_action`
- 공통 슬롯 루프: 부족 파라미터 순차 수집
- 공통 실행기: `validated payload`로 tool 실행
- 공통 응답기: 사용자 메시지 출력

### 단계별 체크리스트
- [x] 1단계. 코어 계약(Plan/Task) 공통 검증 도입
- [x] 2단계. Planner 서비스 하드코딩 제거(인텐트+툴 메타 기반 task 합성)
- [x] 3단계. Slot schema 외부화(tool spec 확장 기반)
- [x] 4단계. Executor 레거시 함수 정리/제거
- [x] 5단계. Tool runner adapter registry 패턴화
- [x] 6단계. Telegram 라우트 책임 분리
- [x] 7단계. 구조 회귀 테스트/CI 가드 강화

### 1단계 진행 메모
- `plan_contract` 공통 검증기 추가 (`backend/agent/plan_contract.py`)
- `run_agent_analysis` 실행 전 계약 검증 연동
- 검증 실패 시 `plan_contract_invalid`로 fail-closed 처리
- 테스트 추가: invalid plan이 실행 단계로 진입하지 않음을 보장

### 2단계 진행 메모 (완료)
- `planner.build_execution_tasks`를 인텐트 + tool name token 기반으로 재구성
- 서비스 비종속 primary tool 합성 경로 추가 (`selected_tools + intent`)
- `selected_tools`가 불완전해도 실행이 끊기지 않도록 최소 기본 tool 보강 fallback 유지(안정성 목적)
- 신규 spec-only 서비스 포함 회귀 테스트 통과 유지

### 3단계 진행 메모 (완료)
- `slot_schema`에 외부 JSON 스키마 병합 로더 추가 (`SLOT_SCHEMA_PATH`)
- 기본 내장 스키마 + 외부 스키마 override 방식으로 동작
- 외부 스키마 적용 테스트 추가(`test_slot_schema_supports_external_override`)

### 4단계 진행 메모 (완료)
- 실제 실행 경로에서 미사용인 레거시 브릿지 함수 2개 제거
  - `_execute_linear_summary_to_notion_flow`
  - `_requires_spotify_recent_tracks_to_notion`
- 관련 테스트 정리 후 전체 회귀 테스트 통과 유지
- 더 이상 사용하지 않는 레거시 서비스 실행기 진입점 fail-closed 처리
  - `_execute_linear_plan`
  - `_execute_notion_plan`

### 5단계 진행 메모 (완료)
- `tool_runner.execute_tool`의 서비스 분기를 adapter registry로 단순화
  - `_SERVICE_EXECUTORS` 매핑으로 `service -> executor` 일원화
- Notion payload 정규화도 공통 전처리 함수로 분리
  - `_normalize_payload_for_tool`

### 6단계 진행 메모 (완료)
- Telegram 라우트의 응답/문구 생성 책임을 별도 모듈로 분리
  - `app/routes/telegram_response_helpers.py`
- `telegram.py`는 webhook 오케스트레이션/입출력 제어 중심으로 축소
- 분리 이후 telegram helper 회귀 테스트 통과 유지

### 7단계 진행 메모 (완료)
- 공통 구조 기준 회귀 세트를 명시한 실행 스크립트 추가
  - `backend/scripts/run_core_regression.sh`
- 핵심 회귀 세트 통과 확인
  - `125 passed` (telegram/loop/executor/planner/slot/tool_runner 주요 세트)
- 레거시 E2E 스위트(`tests/test_agent_executor_e2e.py`)는 현재 공통 오케스트레이션 구조와 기대치가 달라 기본 경로에서 분리(skip) 처리
- 전체 테스트 통과 상태 확인: `182 passed, 30 skipped`
- CI 기본 게이트 추가: `.github/workflows/backend-core-regression.yml`
- README 테스트 섹션에 core regression 실행 경로 명시
- planner 하드코딩 제거 보강:
  - `linear/notion` 문자열 fallback 제거
  - `selected_tools` 누락 시에도 `registry.list_available_tools(target_services)` 기반 token 매칭으로 task 합성 유지

## 테스트 시나리오(요약)
- 성공 케이스: linear/notion 생성·수정 요청
- 슬롯 보완 케이스: 필수 파라미터 누락 후 순차 입력
- 실패 케이스: 잘못된 ID/권한 오류/미연동 상태
- 모드 케이스:
  - debug off: 대화형 답변만
  - debug on: 대화형 답변 + 상세 리포트

## 추가 작업(선택, 마지막 단계)
### A-1. 위험 작업 확인 게이트(UX 제안 5)
- 변경/삭제 계열은 실행 전 요약 + 명시적 사용자 승인 필수
- 조회/생성 계열은 제한적 기본값 허용, 불확실 시 확인 질문 유지

### A-2. 선택형 옵션 입력 UX(UX 제안 8)
- `team_id` 등 후보가 있는 슬롯은 텍스트 재입력 대신 선택형 옵션 우선 제공
- 동명이인/복수 후보는 번호 선택 또는 버튼 선택으로 확정

### 선택 적용 체크리스트
- [ ] A-1 위험 작업 확인 게이트 적용
- [ ] A-2 선택형 옵션 입력 UX 적용
